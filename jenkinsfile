pipeline {
    agent any

    environment {
        AWS_SERVER = "ec2-user@your-aws-ec2-ip"
        BACKEND_DIR = "backend"
        FRONTEND_DIR = "frontend"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git 'https://github.com/Sayali-kamble/TourPlanner.git'
            }
        }

        stage('Build Backend with Maven') {
            steps {
                sh 'cd $BACKEND_DIR && mvn clean package'
            }
        }

        stage('Run Unit Tests') {
            steps {
                sh 'cd $BACKEND_DIR && mvn test'
            }
        }

        stage('Build Frontend with React') {
            steps {
                sh '''
                cd $FRONTEND_DIR
                npm install
                npm run build
                '''
            }
        }

        stage('Deploy to AWS EC2') {
            steps {
                sshagent(['EC2-SSH-Key']) {
                    sh '''
                    scp -r $BACKEND_DIR/target/*.jar $AWS_SERVER:/home/ec2-user/tourplanner.jar
                    scp -r $FRONTEND_DIR/build/* $AWS_SERVER:/var/www/html/
                    ssh $AWS_SERVER <<EOF
                    nohup java -jar /home/ec2-user/tourplanner.jar > /dev/null 2>&1 &
                    EOF
                    '''
                }
            }
        }
    }
}

